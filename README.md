# 硅片数片机 (Silicon Wafer Counter)

## 1. 项目概述 (Project Overview)
本项目旨在解决半导体生产过程中硅片计数的自动化问题。通过机器视觉技术，对叠放的单晶硅片图像进行分析，自动计算硅片的数量，替代传统的人工计数或称重方法，提高效率和准确性。

## 2. 问题分析 (Problem Analysis)
待处理的图像为叠放的硅片侧面图。
- **特征**：硅片在图像中表现为一系列平行排列的线条或纹理。
- **难点**：
    - 光照不均匀可能导致部分区域对比度低。
    - 噪声干扰可能产生伪边缘。
    - 硅片之间的间距可能因拍摄角度或堆叠紧密程度而略有不同。

## 3. 解决方案与算法思路 (Solution Approach)

本项目采用 **基于梯度的水平投影分析法 (Gradient-based Horizontal Projection Analysis)**。

### 3.1 算法流程
1.  **图像预处理 (Preprocessing)**:
    - **灰度化**: 将彩色图像转换为灰度图。
    - **对比度增强 (CLAHE)**: 使用限制对比度自适应直方图均衡化 (CLAHE) 增强图像细节，特别是暗部的纹理。
    - **高斯滤波 (Gaussian Blur)**: 平滑图像，去除高频噪声。

2.  **特征提取 (Feature Extraction)**:
    - **垂直梯度计算 (Sobel Y)**: 利用 Sobel 算子计算图像在垂直方向上的梯度。硅片的边缘在垂直方向上会有强烈的梯度响应。
    - **水平投影 (Horizontal Projection)**: 将梯度图像沿水平方向求平均值，得到一个一维的垂直分布曲线（Profile）。该曲线的波峰对应硅片的边缘或中心。

3.  **计数 (Counting)**:
    - **频域分析 (Frequency Analysis)**: 对投影曲线进行傅里叶变换 (FFT)，提取主频，从而估计硅片的平均间距 (Period)。
    - **峰值检测 (Peak Detection)**: 使用 `scipy.signal.find_peaks` 函数检测投影曲线中的波峰。
    - **自适应参数**: 根据 FFT 估计的间距设置最小峰值距离 (distance)，确保不会对同一个硅片重复计数。

4.  **可视化 (Visualization)**:
    - 在原图上绘制检测到的分割线。
    - 显示总计数。

## 4. 项目结构 (Project Structure)

```
gemini/
├── core/
│   └── wafer_counter.py    # 核心算法实现类 (WaferCounter)
├── input/                  # 输入图片文件夹
├── output_results/         # 结果输出文件夹
├── batch_process.py        # 批量处理工具 (CLI Support)
├── main.py                 # 图形用户界面 (GUI) 入口程序
├── requirements.txt        # 项目依赖列表
└── README.md               # 项目说明文档
```

## 5. 环境依赖 (Dependencies)
本项目基于 Python 3 开发，依赖以下库。
**代码已全面兼容 Numpy 2.0+，无版本限制。**

- `opencv-python`: 图像处理
- `numpy`: 数值计算
- `scipy`: 信号处理 (峰值检测)
- `matplotlib`: (可选) 绘图
- `Pillow`: GUI 图像显示

安装命令：
```bash
pip install -r requirements.txt
```

## 6. 使用说明 (Usage)

### 6.1 图形界面 (GUI)
1.  **启动程序**:
    ```bash
    python main.py
    ```
2.  **操作步骤**:
    - 点击 **"Load Image"** 加载图片。
    - 点击 **"Process"** 开始计数。

### 6.2 批量处理 (Batch Processing)
支持通过命令行批量处理图片，自动生成结果图。

**基本用法**:
```bash
python batch_process.py
```

**自定义路径**:
```bash
python batch_process.py --input my_images --output results
```

**参数说明**:
- `--input`, `-i`: 输入图片文件夹路径 (默认: `input`)
- `--output`, `-o`: 结果保存路径 (默认: `output_results`)
- `--save-plot`: (可选) 是否保存中间过程分析图

2.  **操作步骤**:
    - 点击 **"Load Image (加载图像)"** 按钮，选择一张测试图片（如 `P0308120111.jpg`）。
    - 点击 **"Process (开始计数)"** 按钮。
    - 程序将在界面上显示处理后的图像（带有红色标记线）以及计算出的硅片总数。

## 7. 总结 (Conclusion)
本方案利用了硅片堆叠的几何特性（平行纹理），通过梯度投影将二维图像分析转化为一维信号处理问题，大大降低了计算复杂度，并提高了鲁棒性。引入 FFT 进行自适应参数估计，使得算法能够适应不同缩放比例的图像。

---
*Generated by Gemini 3 Pro (Preview)*
